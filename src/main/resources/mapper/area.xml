<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.home.domain.mapper.AreaMapper">

    <select id="findSido" resultType="String">
        select distinct sido from area
    </select>

    <select id="findGugun" parameterType="String" resultType="String">
        select distinct gugun from area where sido = #{sido} and dong is not null
    </select>

    <select id="findDong" parameterType="map" resultType="String">
        select distinct dong from area where sido=#{sido} and gugun = #{gugun} and dong is not null
    </select>

    <select id="findArea" parameterType="map" resultType="HouseInfoRequest">
        WITH LatestDeals AS (
            SELECT
                housedeal.apt_id,
                housedeal.deal_amount,
                ROW_NUMBER() OVER (
            PARTITION BY housedeal.apt_id
            ORDER BY housedeal.deal_year DESC, housedeal.deal_month DESC, housedeal.deal_day DESC
        ) AS rn
            FROM
                housedeal
        )
        SELECT
            houseinfo.apt_id AS aptId,
            houseinfo.build_year AS buildYear,
            houseinfo.sigungu_code AS sigunguCode,
            houseinfo.eubmyundong_code AS eubmyundongCode,
            houseinfo.area_id AS areaId,
            houseinfo.jibun,
            houseinfo.apartmentName,
            houseinfo.longitude,
            houseinfo.latitude,
            LatestDeals.deal_amount AS dealAmount
        FROM
            houseinfo
                INNER JOIN
            LatestDeals ON houseinfo.apt_id = LatestDeals.apt_id
        WHERE
            LatestDeals.rn = 1
            and area_id = (select area_id from area where sido= #{sido} and gugun = #{gugun} and dong = #{dong})
    </select>
</mapper>