<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.home.domain.mapper.AreaMapper">

    <select id="findSido" resultType="String">
        select distinct sido from area
    </select>

    <select id="sidoInfo" parameterType="String" resultType="AreaInfoDto">
        select #{sido} as address, longitude, latitude
        from addressinfo
        where address_level = 1 and address like #{sido}
    </select>

    <select id="findGugun" parameterType="String" resultType="String">
        select distinct gugun from area where sido = #{sido} and dong is not null
    </select>

    <select id="gugunInfo" parameterType="String" resultType="AreaInfoDto">
        select #{gugun} as address, longitude, latitude
        from addressinfo
        where address_level = 2
        and address like CONCAT('%', #{sido}, '%')
        and address like CONCAT('%', #{gugun}, '%')
    </select>

    <select id="findDong" parameterType="map" resultType="String">
        select distinct dong from area where sido=#{sido} and gugun = #{gugun} and dong is not null
    </select>

    <select id="dongInfo" parameterType="String" resultType="AreaInfoDto">
        select #{dong} as address, longitude, latitude
        from addressinfo
        where address_level = 3
        and address like CONCAT('%', #{sido}, '%')
        and address like CONCAT('%', #{gugun}, '%')
        and address like CONCAT('%', #{dong}, '%')
    </select>

    <select id="findArea" parameterType="map" resultType="HouseInfoDto">
        WITH LatestDeals AS (
            SELECT
                housedeal.apt_id,
                housedeal.deal_amount,
                housedeal.size,
                ROW_NUMBER() OVER (
            PARTITION BY housedeal.apt_id
            ORDER BY housedeal.deal_year DESC, housedeal.deal_month DESC, housedeal.deal_day DESC
        ) AS rn
            FROM
                housedeal
        )
        SELECT
            houseinfo.apt_id AS aptId,
            houseinfo.build_year AS buildYear,
            houseinfo.sigungu_code AS sigunguCode,
            houseinfo.eubmyundong_code AS eubmyundongCode,
            houseinfo.area_id AS areaId,
            houseinfo.jibun,
            houseinfo.apartmentName,
            houseinfo.longitude,
            houseinfo.latitude,
            LatestDeals.deal_amount AS dealAmount,
            LatestDeals.size,
            area.sido,
            area.gugun,
            area.dong
        FROM houseinfo
        INNER JOIN LatestDeals ON houseinfo.apt_id = LatestDeals.apt_id
        INNER JOIN area ON houseinfo.area_id = area.area_id
        WHERE
            LatestDeals.rn = 1
            and houseinfo.area_id = (select area_id from area where sido= #{sido} and gugun = #{gugun} and dong = #{dong})
    </select>

    <select id="aptInfo" parameterType="String" resultType="HouseDto">
        SELECT
            houseinfo.apt_id AS aptId,
            houseinfo.build_year AS buildYear,
            houseinfo.area_id AS areaId,
            area.sido,
            area.gugun,
            area.dong,
            houseinfo.jibun,
            houseinfo.apartmentName,
            housedeal.deal_amount AS dealAmount,
            housedeal.size,
            housedeal.floor,
            housedeal.deal_year as dealYear,
            housedeal.deal_month as dealMonth,
            housedeal.deal_day as dealDay
        FROM houseinfo
                 INNER JOIN housedeal ON houseinfo.apt_id = housedeal.apt_id
                 INNER JOIN area ON houseinfo.area_id = area.area_id
        WHERE houseinfo.apt_id = #{aptId}
    </select>
</mapper>